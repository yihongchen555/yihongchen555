<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="yihong" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", Observability, " />

<meta property="og:title" content="Opentelemetry "/>
<meta property="og:url" content="/opentelemetry.html" />
<meta property="og:description" content="Table of Contents OpenTelemetry Setup loki logs label prometheus metrics label link prometheus to tempo using exemplar link loki traceid label to tempo tempo service graphs and span metrics opentelemetry collector debug exporter tempo trace to logs Using loki, prometheus, tempo in grafana using loki using prometheus using tempo find …" />
<meta property="og:site_name" content="yihong&#39;s blog" />
<meta property="og:article:author" content="yihong" />
<meta property="og:article:published_time" content="2024-04-18T12:03:00+08:00" />
<meta name="twitter:title" content="Opentelemetry ">
<meta name="twitter:description" content="Table of Contents OpenTelemetry Setup loki logs label prometheus metrics label link prometheus to tempo using exemplar link loki traceid label to tempo tempo service graphs and span metrics opentelemetry collector debug exporter tempo trace to logs Using loki, prometheus, tempo in grafana using loki using prometheus using tempo find …">

        <title>Opentelemetry  · yihong&#39;s blog
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>yihong's blog</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >Home</a>
                                </li>
                                <li ><a href="/categories.html">Categories</a></li>
                                <li ><a href="/tags.html">Tags</a></li>
                                <li ><a href="/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/opentelemetry.html">
                Opentelemetry
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#opentelemetry-setup">OpenTelemetry Setup</a><ul>
<li><a href="#loki-logs-label">loki logs label</a></li>
<li><a href="#prometheus-metrics-label">prometheus metrics label</a></li>
<li><a href="#link-prometheus-to-tempo-using-exemplar">link prometheus to tempo using exemplar</a></li>
<li><a href="#link-loki-traceid-label-to-tempo">link loki traceid label to tempo</a></li>
<li><a href="#tempo-service-graphs-and-span-metrics">tempo service graphs and span metrics</a></li>
<li><a href="#opentelemetry-collector-debug-exporter">opentelemetry collector debug exporter</a></li>
<li><a href="#tempo-trace-to-logs">tempo trace to logs</a></li>
</ul>
</li>
<li><a href="#using-loki-prometheus-tempo-in-grafana">Using loki, prometheus, tempo in grafana</a><ul>
<li><a href="#using-loki">using loki</a></li>
<li><a href="#using-prometheus">using prometheus</a></li>
<li><a href="#using-tempo">using tempo</a><ul>
<li><a href="#find-requests-with-higher-than-usual-latency">find requests with higher than usual latency</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#application-code">Application code</a><ul>
<li><a href="#python">Python</a></li>
<li><a href="#csharp-dotnet">CSharp Dotnet</a></li>
</ul>
</li>
<li><a href="#troubleshooting-showing-spans-in-table-in-tempo">Troubleshooting Showing Spans in table in Tempo</a></li>
<li><a href="#troubleshooting-viewing-traces-in-table-with-duration-in-tempo">Troubleshooting Viewing Traces in table with duration in Tempo</a></li>
<li><a href="#troubleshooting-upgrading-grafana-with-persistent-volume-claim">Troubleshooting Upgrading Grafana with persistent volume claim</a></li>
<li><a href="#temporary-link-reference">Temporary Link Reference</a></li>
</ul>
</div>
<h1 id="opentelemetry-setup">OpenTelemetry Setup</h1>
<h2 id="loki-logs-label">loki logs label</h2>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/lokiexporter/README.md">loki exporter documentation</a></p>
<p>in opentelemetry collector values.yaml, add loki under <code>exporter</code>, add</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">loki</span><span class="p">:</span>
<span class="w">      </span><span class="n">endpoint</span><span class="p">:</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">loki</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">3100</span><span class="o">/</span><span class="n">loki</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">push</span>
<span class="w">      </span><span class="n">default_labels_enabled</span><span class="p">:</span>
<span class="w">        </span><span class="n">exporter</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">        </span><span class="n">job</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">        </span><span class="n">level</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">        </span><span class="n">instance</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span>
<span class="w">      </span><span class="n">tls</span><span class="p">:</span>
<span class="w">        </span><span class="n">insecure</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
</code></pre></div>

<p>under <code>processor</code>, add</p>
<div class="highlight"><pre><span></span><code>    attributes:
      actions:
        - action: insert
          key: loki.attribute.labels
          value: event.domain, event.name
    resource:
      attributes:
        - action: insert
          key: loki.resource.labels
          value: service.name, service.namespace
</code></pre></div>

<p>under <code>service.pipelines.log</code>, add</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="n">exporters</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">debug</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">loki</span>
<span class="w">        </span><span class="n">processors</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">memory_limiter</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">batch</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">attributes</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">resource</span>
<span class="w">        </span><span class="n">receivers</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">otlp</span>
</code></pre></div>

<h2 id="prometheus-metrics-label">prometheus metrics label</h2>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/prometheusexporter">prometheus exporter documentation</a></p>
<p>in opentelemetry collector values.yaml, add prometheus under <code>exporter</code>, add</p>
<div class="highlight"><pre><span></span><code>    prometheusremotewrite:
      endpoint: http://prometheus.namespace.svc.cluster.local:80/api/v1/write
      tls:
        insecure: true
      resource_to_telemetry_conversion:
        enabled: true
</code></pre></div>

<p>under <code>service.pipelines.metrics</code>, add</p>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="n">metrics</span><span class="p">:</span>
<span class="w">        </span><span class="n">exporters</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">debug</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">prometheusremotewrite</span>
<span class="w">        </span><span class="n">processors</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">memory_limiter</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">batch</span>
<span class="w">          </span><span class="c1">#- transform</span>
<span class="w">        </span><span class="n">receivers</span><span class="p">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">otlp</span>
<span class="w">          </span><span class="c1">#- prometheus</span>
</code></pre></div>

<h2 id="link-prometheus-to-tempo-using-exemplar">link prometheus to tempo using exemplar</h2>
<p>in prometheus config, add the following flags during start-up:</p>
<div class="highlight"><pre><span></span><code>--enable-feature=exemplar-storage
--web.enable-remote-write-receiver
</code></pre></div>

<p>in prometheus datasource config, fill in the exemplar settings as mentioned in the below link</p>
<ol>
<li><a href="https://grafana.com/docs/grafana/latest/datasources/prometheus/configure-prometheus-data-source/#exemplars">grafana prometheus link</a></li>
</ol>
<p>The settings are:</p>
<p><code>Internal link, URL,Data source,URL label, Label name</code></p>
<p>in tempo config, enable <code>metrics_generator</code> and add the following config:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics_generator</span><span class="o">:</span>
<span class="w">      </span><span class="n">storage</span><span class="o">:</span>
<span class="w">        </span><span class="n">path</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;/tmp/tempo&quot;</span>
<span class="w">        </span><span class="n">remote_write</span><span class="o">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="n">http</span><span class="o">://</span><span class="n">prometheus</span><span class="o">.</span><span class="na">namespace</span><span class="o">.</span><span class="na">svc</span><span class="o">.</span><span class="na">cluster</span><span class="o">.</span><span class="na">local</span><span class="o">:</span><span class="mi">80</span><span class="sr">/api/v1/</span><span class="n">write</span>
<span class="w">            </span><span class="n">send_exemplars</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
</code></pre></div>

<p>exemplars are important to us when we want to find out outliers data, like request with higher latency than average</p>
<p>note that you need to instrument code in your application for exemplars to work, see</p>
<ol>
<li>
<p><a href="https://cloud.google.com/stackdriver/docs/managed-prometheus/exemplars#prom-exemplars-write">link</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-examples/tree/main/prometheus#prometheus-example">otel java example</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-examples/blob/main/prometheus/src/main/java/io/opentelemetry/example/prometheus/ExampleConfiguration.java">java exampleconfiguration</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-java-examples/blob/main/prometheus/src/main/java/io/opentelemetry/example/prometheus/PrometheusExample.java">java prometheusexample</a></p>
</li>
<li>
<p><a href="https://prometheus.github.io/client_python/instrumenting/exemplars/">prometheus python exemplar</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=uBvU_3IeK4k&amp;t=643s">create an exemplar</a></p>
</li>
</ol>
<p>for more read</p>
<ol>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/fundamentals/exemplars/">introduction to exemplars</a></p>
</li>
<li>
<p><a href="https://grafana.com/blog/2021/03/31/intro-to-exemplars-which-enable-grafana-tempos-distributed-tracing-at-massive-scale/">intro to exemplars blog</a></p>
</li>
</ol>
<h2 id="link-loki-traceid-label-to-tempo">link loki traceid label to tempo</h2>
<p>in loki datasouce, go to derived field and add the following values:</p>
<ul>
<li>name: <code>traceid</code></li>
<li>regex: <code>\"traceid\":\"(\w+)\"</code></li>
<li>query: <code>${__value.raw}</code></li>
</ul>
<h2 id="tempo-service-graphs-and-span-metrics">tempo service graphs and span metrics</h2>
<p>there are two ways to add service graphs and span metrics in tempo config</p>
<ol>
<li>
<p><a href="https://grafana.com/docs/tempo/latest/configuration/#metrics-generator">metrics generator</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/tempo/latest/configuration/#standard-overrides">overrides</a></p>
</li>
</ol>
<p>service graphs and span metrics configuration parameters in tempo are not as useful as the counterpart in opentelemetry collector, primarily we want to configure <em>p99 latency</em> and <em>higher latency value for exemplar</em></p>
<p>by default, if <code>metrics generatorr</code> is enabled in helm chart <code>values.yaml</code>, the <code>service graphs</code> and <code>span metrics</code> will be added to tempo config under <code>overrides</code></p>
<ol>
<li>
<p><a href="https://github.com/grafana/helm-charts/issues/1987">github issue link 1</a></p>
</li>
<li>
<p><a href="https://github.com/grafana/helm-charts/issues/2286">link 2</a></p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">overrides</span><span class="o">:</span>
<span class="w">      </span><span class="n">per_tenant_override_config</span><span class="o">:</span><span class="w"> </span><span class="sr">/conf/</span><span class="n">overrides</span><span class="o">.</span><span class="na">yaml</span>
<span class="w">      </span><span class="n">metrics_generator_processors</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s1">&#39;service-graphs&#39;</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s1">&#39;span-metrics&#39;</span>
</code></pre></div>

<h2 id="opentelemetry-collector-debug-exporter">opentelemetry collector debug exporter</h2>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/debugexporter/README.md">Debugexporter</a></p>
<p>the option, verbosity, default <code>basic</code> is good enough to see logs, metrics, traces are being transferred</p>
<p>set to <code>detailed</code> only when needed</p>
<h2 id="tempo-trace-to-logs">tempo trace to logs</h2>
<p>When viewing traces/spans, we can see the button <code>Logs for this span</code> to view log for the particular span, I found that the implementation of this button is buggy in old version of Grafana</p>
<p>a way to fix it is to add tags in tempo datasource</p>
<p><code>service.name</code> as <code>service_name</code></p>
<p><a href="https://community.grafana.com/t/trace-to-logs-logs-for-this-span-button-disabled/87825">Trace to Logs (Logs for this Span button disabled)</a></p>
<h1 id="using-loki-prometheus-tempo-in-grafana">Using loki, prometheus, tempo in grafana</h1>
<h2 id="using-loki">using loki</h2>
<p>can use both <code>service_name</code> or <code>job</code> as label to select application</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nx">service_name</span><span class="p">=</span><span class="s">&quot;simple-python-service&quot;</span><span class="p">}</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="err">``</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">json</span>
</code></pre></div>

<p><code>traceid</code> and <code>spanid</code> are included in the logs if the application exports both logs and traces to opentelemetry collectors for processing</p>
<p>the traceid is link to tempo, so you can open the trace directly without cross-referencing tempo to loki</p>
<h2 id="using-prometheus">using prometheus</h2>
<p>can use <code>service_name</code> or <code>job</code> as label in prometheus code metrics browser to select application</p>
<div class="highlight"><pre><span></span><code><span class="nx">dice_rolls_total</span><span class="p">{</span><span class="nx">service_name</span><span class="p">=</span><span class="s">&quot;simple-python-service&quot;</span><span class="p">}</span>
</code></pre></div>

<p>since application is setup to push metrics to the collector (and then push to prometheus), we do not know what metrics are available to us</p>
<p>I found a way to see the metrics available, in grafana explore, choose prometheus, choose metrics browser, set <code>service_name</code> or <code>job</code> and select the application, the metrics will be available on the left</p>
<p>I am still figuring out how to use bucket with histogram quantile</p>
<h2 id="using-tempo">using tempo</h2>
<p>In tempo, choose service graph and run query, we can see table and node graph</p>
<p>under node graph, by left clicking a service, we can see <code>request rate</code>, <code>request histogram</code> and <code>failed request rate</code>, only in newer version of Grafana. In older version of Grafana these 3 options are missing, no idea why, but you can use the queries below to view in old Grafana Prometheus</p>
<p><code>request histogram</code> prometheus query:</p>
<div class="highlight"><pre><span></span><code><span class="nx">histogram_quantile</span><span class="p">(</span><span class="m m-Double">0.9</span><span class="p">,</span><span class="w"> </span><span class="nx">sum</span><span class="p">(</span><span class="nx">rate</span><span class="p">(</span><span class="nx">traces_service_graph_request_server_seconds_bucket</span><span class="p">{</span><span class="nx">server</span><span class="p">=</span><span class="s">&quot;simple-python-service&quot;</span><span class="p">}[</span><span class="err">$</span><span class="nx">__rate_interval</span><span class="p">]))</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="p">(</span><span class="nx">le</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">server</span><span class="p">))</span>
</code></pre></div>

<p><code>request rate</code> prometheus query:</p>
<div class="highlight"><pre><span></span><code><span class="nx">sum</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">server</span><span class="p">)(</span><span class="nx">rate</span><span class="p">(</span><span class="nx">traces_service_graph_request_total</span><span class="p">{</span><span class="nx">server</span><span class="p">=</span><span class="s">&quot;simple-python-service&quot;</span><span class="p">}[</span><span class="err">$</span><span class="nx">__rate_interval</span><span class="p">]))</span>
</code></pre></div>

<p><code>failed request rate</code> prometheus query:</p>
<div class="highlight"><pre><span></span><code><span class="nx">sum</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">server</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">rate</span><span class="p">(</span><span class="nx">traces_service_graph_request_failed_total</span><span class="p">{</span><span class="nx">server</span><span class="p">=</span><span class="s">&quot;simple-python-service&quot;</span><span class="p">}[</span><span class="err">$</span><span class="nx">__rate_interval</span><span class="p">]))</span>
</code></pre></div>

<p>tempo service graph, the default <code>request histogram</code> is not useful</p>
<p>the tempo config cannot be configured to send only higher latency span metrics as exemplars, so these exemplars emitted are not useful</p>
<p>the duration (p90) in the table is also not useful as we want to see <em>p99 latency</em></p>
<p>need to research how to achieve these two objectives in tempo or opentelemetry collector</p>
<ol>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/issues/23872">github issue link 1</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/issues/28852">link 2</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/spanmetricsconnector">span metrics connector link</a></p>
</li>
</ol>
<h3 id="find-requests-with-higher-than-usual-latency">find requests with higher than usual latency</h3>
<p>We are interested in finding out the duration of many requests in an overview</p>
<p>By default, the <code>Search</code> tab in tempo will show you traces, the traces don't show you the duration</p>
<p>To see duration of the requests, we can search spans instead of traces</p>
<p>in tempo, choose TraceQL, in the query, type the following</p>
<div class="highlight"><pre><span></span><code>{span.http.route=&quot;/readiness&quot; &amp;&amp; duration &gt; 0.13ms }
{span.http.route=&quot;/rolldice&quot; &amp;&amp; duration &gt; 0.7ms }
</code></pre></div>

<p>in Options, table format, choose <code>Spans</code> instead of <code>Traces</code>, and then <code>Run Query</code></p>
<p>it is easier this way to find out higher latency requests</p>
<p>for more, please read official TraceQL documentation <a href="https://grafana.com/docs/tempo/latest/traceql/">link</a></p>
<p>by selecting a trace/span, you can see the node graph and the trace</p>
<p>note that node graph has to be enabled explicitly in tempo datasource</p>
<h1 id="application-code">Application code</h1>
<h2 id="python">Python</h2>
<p>In python, using flask, the exporter for each back-end is configured at start-up time as below:</p>
<div class="highlight"><pre><span></span><code><span class="n">opentelemetry</span><span class="o">-</span><span class="n">instrument</span><span class="w"> </span><span class="o">--</span><span class="n">metrics_exporter</span><span class="w"> </span><span class="n">otlp</span><span class="w"> </span><span class="o">--</span><span class="n">traces_exporter</span><span class="w"> </span><span class="n">otlp</span><span class="w"> </span><span class="o">--</span><span class="n">logs_exporter</span><span class="w"> </span><span class="n">otlp</span><span class="w"> </span><span class="n">flask</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">8080</span>
</code></pre></div>

<h2 id="csharp-dotnet">CSharp Dotnet</h2>
<p>the exporter for each back-end is configured in code or environment variable</p>
<ol>
<li>
<p><a href="https://opentelemetry.io/docs/languages/net/automatic/instrumentations/">Available instrumentations</a></p>
</li>
<li>
<p><a href="https://opentelemetry.io/docs/languages/net/automatic/config/">Configuration and settings</a></p>
</li>
</ol>
<p>the following is an example of configuration in code:</p>
<div class="highlight"><pre><span></span><code>using OpenTelemetry.Logs;
using OpenTelemetry.Metrics;
using OpenTelemetry.Trace;

builder.Logging.AddOpenTelemetry(options =&gt;
{
    options
        .AddOtlpExporter();
});

builder.Services.AddOpenTelemetry()
      .WithTracing(tracing =&gt; tracing
          .AddAspNetCoreInstrumentation()
          .AddOtlpExporter())
      .WithMetrics(metrics =&gt; metrics
          .AddAspNetCoreInstrumentation()
          .AddOtlpExporter());
</code></pre></div>

<p><strong>Bug</strong></p>
<p>I found that the official documentation example of using <code>Microsoft.AspNetCore.Mvc</code> have a different outcome</p>
<ol>
<li><a href="https://opentelemetry.io/docs/languages/net/getting-started/">Opentelemetry .NET Getting Started</a></li>
</ol>
<p>When I only expect the logs to be sent to OpenTelemetry, it also outputs the logs to the console</p>
<p>It could be due to the dependency injection not being handled explicitly by the aspnetcore library (I could be wrong). Expecting that if this is fixed, there will be an extra flag for Logging in <code>appsettings.json</code></p>
<p>Quote from below links in github <code>opentelemetry-dotnet docs logs</code> (different from <code>opentelemetry-dotnet examples</code>,</p>
<ol>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-dotnet/tree/main/docs/logs/getting-started-aspnetcore">Getting Started with OpenTelemetry .NET Logs in 5 Minutes - ASP.NET Core Application</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-dotnet/blob/main/docs/logs/getting-started-console/README.md">Getting Started with OpenTelemetry .NET Logs in 5 Minutes - Console Application</a></p>
</li>
</ol>
<blockquote>
<p>There are cases where logging is needed before the dependency injection (DI) logging pipeline is available (e.g. before builder.Build()) or after the DI logging pipeline is disposed (e.g. after app.Run()). The common practice is to use a separate logging pipeline by creating a LoggerFactory instance.</p>
<p>Refer to the Getting Started with OpenTelemetry .NET Logs in 5 Minutes - Console Application tutorial to learn more about how to create a LoggerFactory instance and configure OpenTelemetry to work with it.</p>
</blockquote>
<p>While another example for automatic instrumentation does not use <code>Microsoft.AspNetCore.Mvc</code></p>
<ol>
<li><a href="https://opentelemetry.io/docs/languages/net/automatic/getting-started/">automatic instrumentation getting started .NET</a></li>
</ol>
<p>And the documentations for csharp dotnet opentelemetry is a bit confusing, I skipped some of the articles</p>
<p><em>found something interesting</em></p>
<p>updated: this method should not work, have not tested</p>
<p>in <code>appsettings.json</code>, probably can set <code>"Microsoft.AspNetCore.Mvc.Internal": "Warning"</code> so the output to console is limited, or set it to <code>None</code></p>
<ol>
<li><a href="https://stackoverflow.com/questions/35251078/how-to-turn-off-the-logging-done-by-the-asp-net-core-framework">How to turn off the logging done by the ASP.NET core framework</a></li>
</ol>
<p>Extra links during troubleshooting:</p>
<ol>
<li>
<p><a href="https://signoz.io/blog/opentelemetry-dotnet-logs/">How to Collect .NET Application Logs with OpenTelemetry</a></p>
</li>
<li>
<p><a href="https://github.com/open-telemetry/opentelemetry-dotnet/tree/main/examples">opentelemetry-dotnet examples</a></p>
</li>
</ol>
<h1 id="troubleshooting-showing-spans-in-table-in-tempo">Troubleshooting Showing Spans in table in Tempo</h1>
<ol>
<li>
<p><a href="https://www.google.com/search?q=trace+how+to+view+by+span+duration+tempo">trace how to view by span duration tempo</a></p>
<p>a) <a href="https://community.grafana.com/t/showing-custom-trace-span-attributes-in-table/113898">Showing custom trace/span attributes in table</a></p>
<p>b) <a href="https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/table/">Table</a></p>
<p>c) <a href="https://www.youtube.com/watch?v=PCY7O8EJeJY&amp;t=20s">Deep Dive - Table Panel Visualizations: What Are They? How to Get Started? | Grafana</a></p>
</li>
</ol>
<h1 id="troubleshooting-viewing-traces-in-table-with-duration-in-tempo">Troubleshooting Viewing Traces in table with duration in Tempo</h1>
<ol>
<li>
<p><a href="https://grafana.com/docs/tempo/latest/traceql/query-editor/traceql-editor/">Write TraceQL queries with the editor</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/tempo/latest/traceql/query-editor/traceql-search/">Search traces using TraceQL query builder</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/feature-toggles/">Configure feature toggles</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/traces/">Traces</a></p>
</li>
</ol>
<p>Finding out why trace id duration is undefined</p>
<ol>
<li>
<p><a href="https://www.google.com/search?q=trace+id+duration+undefined+grafana+tempo">trace id duration undefined grafana tempo</a></p>
<p>a) <a href="https://grafana.com/docs/tempo/latest/troubleshooting/unable-to-see-trace/">Unable to find traces</a></p>
<p>b) <a href="https://grafana.com/docs/grafana/latest/explore/trace-integration/">Tracing in Explore</a></p>
</li>
</ol>
<p>To check whether other language implementation emitted duration data in traces</p>
<ol>
<li>
<p><a href="https://www.google.com/search?q=grafana+tempo+demo">grafana tempo demo</a></p>
<p>a) <a href="https://grafana.com/docs/tempo/latest/getting-started/example-demo-app/">Example setups</a></p>
</li>
<li>
<p><a href="https://www.google.com/search?q=grafana+tempo+with+microservices+demo">grafana tempo with microservices demo</a></p>
</li>
</ol>
<p>To check why tempo traceid do not show duration</p>
<ol>
<li>
<p><a href="https://www.google.com/search?q=traceid+dont+have+duration+tempo">traceid dont have duration tempo</a></p>
<p>a) <a href="https://github.com/grafana/tempo/issues/1405">Why can not see traceID from loki?</a></p>
<p>b) <a href="https://community.grafana.com/t/tempo-cant-find-the-traceid/107603">Tempo cant find the traceid</a></p>
</li>
</ol>
<h1 id="troubleshooting-upgrading-grafana-with-persistent-volume-claim">Troubleshooting Upgrading Grafana with persistent volume claim</h1>
<p>search: <a href="https://www.google.com/search?q=can+we+recover+data+from+persistent+volume+claim+after+pod+deletion">can we recover data from persistent volume claim after pod deletion</a></p>
<ol>
<li>
<p><a href="https://stackoverflow.com/questions/65210123/how-to-recover-pvreleased-data-after-pvc-deletion">How to recover pv(Released) data after pvc deletion</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#retain">Persistent Volumes</a></p>
</li>
<li>
<p><a href="https://www.google.com/search?q=storage+asset+definition">storage asset definition</a></p>
</li>
<li>
<p><a href="https://www.google.com/search?q=associated+storage+asset">associated storage asset</a></p>
<p>a) <a href="https://docs.openshift.com/container-platform/4.15/storage/understanding-persistent-storage.html">Understanding persistent storage</a></p>
<p>b) <a href="https://rtfm.co.ua/en/kubernetes-persistentvolume-and-persistentvolumeclaim-an-overview-with-examples/#Deleting_PV_and_PVC_%E2%80%93_an_example">Deleting PV and PVC – an example</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/">Configure a Pod to Use a PersistentVolume for Storage</a></p>
</li>
</ol>
<p>search: <a href="https://www.google.com/search?q=kubernetes+volume+snapshot">kubernetes volume snapshot</a></p>
<ol>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/volume-snapshots">About volume snapshots</a></p>
</li>
<li>
<p><a href="https://docs.digitalocean.com/products/kubernetes/how-to/create-snapshots/">How to Create Volume Snapshots in Kubernetes Clusters</a></p>
</li>
<li>
<p><a href="https://kubernetes-csi.github.io/docs/snapshot-restore-feature.html">Snapshot &amp; Restore Feature</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volume-snapshots/">Volume Snapshots</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/volume-snapshot-classes/">Volume Snapshot Classes</a></p>
</li>
</ol>
<p>search: <a href="https://www.google.com/search?q=does+persistent+volume+claim+get+reused+when+a+new+pod+start">does persistent volume claim get reused when a new pod start</a></p>
<ol>
<li>
<p><a href="https://stackoverflow.com/questions/73686342/can-i-reuse-same-persistent-volume-for-another-persistentvolumeclaim-with-an-acc">Can I reuse same Persistent Volume for another PersistentVolumeClaim with an access mode of <code>ReadWriteOnce</code>?</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/54137629/automatically-reusing-persistent-volume-including-data">Automatically reusing persistent volume including data</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/68258438/reuse-pv-in-deployment">Reuse PV in Deployment</a></p>
</li>
</ol>
<h1 id="temporary-link-reference">Temporary Link Reference</h1>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2024-04-18T12:03:00+08:00">Thu 18 April 2024</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#observability-ref">Observability</a>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>